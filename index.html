<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Space of liukai93">
<meta property="og:url" content="http://lk1ngaa7.github.io/index.html">
<meta property="og:site_name" content="Space of liukai93">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Space of liukai93">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://lk1ngaa7.github.io/"/>





  <title>Space of liukai93</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Space of liukai93</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lk1ngaa7.github.io/2018/02/25/php-strsearch-function-investigation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="liukai93">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Space of liukai93">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/25/php-strsearch-function-investigation/" itemprop="url">php-strsearch_function_investigation</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-25T18:08:33+08:00">
                2018-02-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lk1ngaa7.github.io/2018/02/25/javascript-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="liukai93">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Space of liukai93">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/25/javascript-notes/" itemprop="url">javascript-notes</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-25T18:07:42+08:00">
                2018-02-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lk1ngaa7.github.io/2018/02/25/mysql-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="liukai93">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Space of liukai93">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/25/mysql-notes/" itemprop="url">mysql-notes</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-25T18:07:33+08:00">
                2018-02-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lk1ngaa7.github.io/2017/02/11/hijack-on-network/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="liukai93">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Space of liukai93">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/11/hijack-on-network/" itemprop="url">链路劫持小记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-11T22:11:56+08:00">
                2017-02-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近在处理了一些HTTP劫持的案例和拜读业内不少大牛的文章之后，觉得有必要把最近的一些关于劫持案例的分析和思考记录下来，以留作日后备忘。<br>简单谈一下目前遇到的一个案例：<br>​    劫持者应该是利用在运营商内部的便利条件，在网关路由器上添加嗅探程序，嗅探明文HTTP请求数据包，拿到要劫持的数据包之后，马上给请求者返回HTTP response（302 到其他 url），并且立即关闭当前HTTP 请求。劫持者 302 的 url 是原网站的一个计费请求，类似淘宝推广链接。但是比较让人郁闷的是，劫持者返回的数据包是两个 TCP 数据包，偶尔会出现 TCP 报乱序（劫持技术不过关），导致客户端无法识别，从而导致页面白屏，严重影响用户体验！<br>下面介绍一下我是如何从数据包分析和定位劫持路由的：<br>案例背景:</p>
<p>山西移动部分地区，访问国内某中文导航网站出现白屏现象。</p>
<p>页面请求后得到奇怪数据返回：<br><img src="http://7j1zp6.com1.z0.glb.clouddn.com/imageshttpjiechi-1.png" alt=""><br>​    请求中 Connection 字段为 keep alive 且请求协议是 1.0 而返回的header 关闭了请求，返回一段奇怪的js，跳转到另外一个 url。<br>接下来观察 TCP flow：<br>​    这次TCP 连接上有 2 个奇怪的现象，都可以证明这是一次处于链路中的劫持，之后如果遇到类似的情况也可以从这两个方面入手来处理：</p>
<ol>
<li>server 给 client 的 TCP 报的 TTL 不一致，且抖动很大。</li>
<li>server 给 client 的 IP identification  ，出现不符合 RFC 标准的情况<br>TTL 不一致的情况：<br><img src="http://7j1zp6.com1.z0.glb.clouddn.com/imageshttpjiechi-2.png" alt=""><br>​    客户端接受的数据包TTL是 51 ，后面来自真实 server 的TTL 是 47，还有 1022 和 1024（本来应该在前面） 都是两个来自 劫持者的数据包，但是 fin 包在前，提前关闭连接，导致HTTP应用层拿不到正确的数据，导致浏览器白屏。<br><img src="http://7j1zp6.com1.z0.glb.clouddn.com/imageshttpjiechi-3.png" alt=""><br>这次 TCP 连接上的其他数据包，可以看到有部分数据包，被抛弃，而且被抛弃的数据包的 TTL 和 握手包的TTL 相等（一般握手包不会被劫持，说明被抛弃的包是来自 真实的服务器的）是 47 。<br>2 . IP identification 异常现象：<br>RFC定义：<br><img src="http://7j1zp6.com1.z0.glb.clouddn.com/imageshttpjiechi-4.png" alt=""><br>所以对于给定地址和协议的 ip 包来说，它的identification应该是公差为 1 的单调递增数列：<br>但是在这次连接中，劫持者的 identification 等于被劫持的 identification：<br>劫持者：<br><img src="http://7j1zp6.com1.z0.glb.clouddn.com/imageshttpjiechi-5.png" alt=""><br>被劫持者：<br><img src="http://7j1zp6.com1.z0.glb.clouddn.com/imageshttpjiechi-6.png" alt=""><br>仔细看，可以发现 993 和 1022 这两个包的identification 是一样的，多次抓包也是这样，所以这里可以判断，链路上肯定出了问题。<br>从这以上两个特征，基本上可以得出结论：<br>劫持者提前给浏览器返回了响应，且关闭了 HTTP 连接。导致正确的 数据包没有被接受，使得浏览器发生了异常跳转。而用户页面出现白屏的情况是劫持失败，劫持者的数据包乱序（程序错误），导致应用层无法获得争取 HTTP 响应。<br>劫持过程应该类似于：<br><img src="http://7j1zp6.com1.z0.glb.clouddn.com/imageshttpjiechi-7.png" alt=""><br>结论已经获得，但是问题的解决就是要定位到相应的劫持路由，然后向有关部门反馈：<br>定位的方法我推荐几种：</li>
</ol>
<ol>
<li><p>如果出现一定数量的用户反馈，可以多联系几位用户（不同网路环境下(wifi,手机热点)，能复现劫持），抓包，然后获取 trace 截图，如果他们出现某几跳路由的重复，就可以缩小定位范围，或者直接定位路由IP。</p>
</li>
<li><p>根据劫持包的TTL反推，用scapy来构造自定义的，可以复现劫持的HTTP请求包，然后以TTL从1开始递增发包，出现劫持响应时，可以判断劫持者的位置。</p>
<p>参考文章：<br><a href="http://www.freebuf.com/vuls/62561.html" target="_blank" rel="noopener">http://www.freebuf.com/vuls/62561.html</a><br><a href="http://security.tencent.com/index.php/blog/msg/10" target="_blank" rel="noopener">http://security.tencent.com/index.php/blog/msg/10</a><br>谢谢这两篇文章的作者，指定迷津。</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lk1ngaa7.github.io/2016/01/25/pdo-with-mysql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="liukai93">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Space of liukai93">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/01/25/pdo-with-mysql/" itemprop="url">pdo防止注入的原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-01-25T16:41:47+08:00">
                2016-01-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>当提到防止SQL注入的办法时，脑海中总是会想到使用PDO绑定参数的办法或者使用mysql_real_eascape_string()来处理（虽然古老的 mysql_XXX 这类的函数已经不建议使用）。但是PDO是如何防止注入的呢？</p>
<p>在手册中，有这样一段：</p>
<blockquote>
<h1 id="Prepared-statements-and-stored-procedures"><a href="#Prepared-statements-and-stored-procedures" class="headerlink" title="Prepared statements and stored procedures"></a>Prepared statements and stored procedures</h1><p><strong>Many of the more mature databases support the concept of prepared statements. What are they? They can be thought of as a kind of compiled template for the SQL that an application wants to run, that can be customized using variable parameters. Prepared statements offer two major benefits:</strong></p>
<ul>
<li><strong>The query only needs to be parsed (or prepared) once, but can be executed multiple times with the same or different parameters. When the query is prepared, the database will analyze, compile and optimize it’s plan for executing the query. For complex queries this process can take up enough time that it will noticeably slow down an application if there is a need to repeat the same query many times with different parameters. By using a prepared statement the application avoids repeating the analyze/compile/optimize cycle. This means that prepared statements use fewer resources and thus run faster.</strong></li>
<li><strong>The parameters to prepared statements don’t need to be quoted; the driver automatically handles this. If an application exclusively uses prepared statements, the developer can be sure that no SQL injection will occur (however, if other portions of the query are being built up with unescaped input, SQL injection is still possible).</strong></li>
</ul>
<p><strong>Prepared statements are so useful that they are the only feature that PDO will emulate for drivers that don’t support them. This ensures that an application will be able to use the same data access paradigm regardless of the capabilities of the database.</strong></p>
</blockquote>
<p>大概的翻译是：<br><em>很多更成熟的数据库都支持预处理语句的概念。这些是什么？它可以被认为是作为一种通过编译SQL语句模板来运行sql语句的机制。预处理语句可以带来两大好处：</em></p>
<ul>
<li><ul>
<li><em>查询只需要被解析（或编译）一次，但可以执行多次通过相同或不同的参数。当查询处理好后，数据库将分析，编译和优化它的计划来执行查询。对于复杂的查询这个过程可能需要足够的时间，这将显著地使得应用程序变慢，如果有必要，可以多次使用不同的参数 重复相同的查询。通过使用处理好的语句的应用程序避免重复 【分析/编译/优化】 周期。这意味着，预处理语句使用更少的资源，而且运行得更快。</em></li>
<li>绑定的参数不需要使用引号;该驱动程序会自动处理。如果应用程序使用预处理语句，开发人员可以确保不会发生SQL注入（但是，如果查询的其他部分使用了未转义的输入，SQL注入仍然是可能的）。*</li>
</ul>
</li>
</ul>
<p><em>预处理语句非常有用，PDO可以使用一种本地模拟的办法来为没有预处理功能的数据库系统提供这个功能。这保证了一个应用可以使用统一的访问方式来访问数据库。</em></p>
<p>这里讲了使用PDO可以带来两个很好的效果，预编译带来查询速度的提升，变量的绑定可以预防 sql injection，其实PDO的预防sql注入的机制也是类似于使用 mysql_real_escape_string 进行转义，PDO 有两种转义的机制，第一种是本地转义，这种转义的方式是使用单字节字符集（PHP &lt; 5.3.6）来转义的（<a href="http://blog.csdn.net/leixiaohua1020/article/details/12753723" target="_blank" rel="noopener">单字节与多字节</a>），来对输入进行转义，但是这种转义方式有一些<a href="https://github.com/80vul/phpcodz/blob/master/research/pch-018.md" target="_blank" rel="noopener">隐患</a>。隐患主要是：在PHP版本小于5.3.6的时候，本地转义只能转换单字节的字符集，大于 5.3.6 的版本会根据 PDO 连接中指定的 charset 来转义。PHP官方手册这里有<a href="http://php.net/manual/zh/ref.pdo-mysql.connection.php" target="_blank" rel="noopener">说明</a>：</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>The method in the below example can only be used with character sets that share the same lower 7 bit representation as ASCII, such as ISO-8859-1 and UTF-8. Users using character sets that have different representations (such as UTF-16 or Big5) <em>must</em>use the <em>charset</em> option provided in PHP 5.3.6 and later versions.</p>
</blockquote>
<p>所以就是说，<strong>不同的版本的PDO 在本地转义的行为上是有区别的。</strong></p>
<p>第二种方式是PDO，首先将 sql 语句模板发送给Mysql Server，随后将绑定的字符变量再发送给Mysql server，这里的转义是在Mysql Server做的，它是根据你在连接PDO的时候，在charset里指定的编码格式来转换的。这样的转义方式更健全，同时还可以在又多次重复查询的业务场景下，通过复用模板，来提高程序的性能。如果要设置Mysql Server  来转义的话，就要首先执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$pdo-&gt;setAttribute(PDO::ATTR_EMULATE_PREPARES, false);</span><br></pre></td></tr></table></figure>
<p>下面是通过 wireshark 抓到的数据包，来具体显示PDO 查询的过程：<br><a href="http://kingliu-blog.qiniudn.com/images/sql-pdo.png" target="_blank" rel="noopener"><img src="http://kingliu-blog.qiniudn.com/images/sql-pdo.png" alt="img"></a><br>绑定的变量：<br><a href="http://kingliu-blog.qiniudn.com/images/sql-val.png" target="_blank" rel="noopener"><img src="http://kingliu-blog.qiniudn.com/images/sql-val.png" alt="img"></a><br>如果不执行  $pdo-&gt;setAttribute(PDO::ATTR_EMULATE_PREPARES, false);  PDO 只是会将插入的参数使用本地转义之后和SQL模板拼装起来，然后一起发送给Mysql Server。这实际上与使用mysql_real_escape_string()过滤，然后拼装这种做法并没有什么不同。</p>
<p> 要对数据库的安全做出更加全面的考量，以下两种方式任选其一：</p>
<p>A. 通过添加(php 5.3.6以前版本)：$pdo-&gt;setAttribute(PDO::ATTR_EMULATE_PREPARES, false);<br>B.  升级到php 5.3.6 (不用设置PDO::ATTR_EMULATE_PREPARES也可以)<br>为了程序移植性和统一安全性，建议使用 $pdo-&gt;setAttribute(PDO::ATTR_EMULATE_PREPARES, false) 方法。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lk1ngaa7.github.io/2016/01/11/websocket-with-php/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="liukai93">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Space of liukai93">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/01/11/websocket-with-php/" itemprop="url">websocket解析和 php 实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-01-11T21:45:06+08:00">
                2016-01-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Websocket-协议解析"><a href="#Websocket-协议解析" class="headerlink" title="Websocket 协议解析"></a>Websocket 协议解析</h1><p>​    WebSocket protocol 是HTML5一种新的协议。它是实现了浏览器与服务器全双工通信(full-duplex)。现很多网站为了实现即时通讯，所用的技术都是轮询(polling)。轮询是在特定的的时间间隔（如每1秒），由浏览器对服务器发出HTTP request，然后由服务器返回最新的数据给客服端的浏览器。这种传统的HTTP request 的模式带来很明显的缺点 – 浏览器需要不断的向服务器发出请求，然而HTTP request 的header是非常长的，里面包含的数据可能只是一个很小的值，这样会占用很多的带宽。</p>
<p>​    在 WebSocket API，浏览器和服务器只需要要做一个握手的动作，然后，浏览器和服务器之间就形成了一条快速通道。两者之间就直接可以数据互相传送，改变了原有的B/S模式。</p>
<p><a href="https://www.flickr.com/photos/101451303@N08/15831324266" target="_blank" rel="noopener"><img src="https://farm9.staticflickr.com/8598/15831324266_5e16ea3fc1_o.png" alt="server"></a></p>
<p>Websocket 数据：</p>
<p><a href="https://www.flickr.com/photos/101451303@N08/15671127979" target="_blank" rel="noopener"><img src="https://farm8.staticflickr.com/7508/15671127979_acba8f202d_o.png" alt="websocket"></a></p>
<p>浏览器端的websocket 请求一般是</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// javacsript</span></span><br><span class="line"><span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">"ws://127.0.0.1:4000"</span>);</span><br><span class="line">ws.onopen = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"succeed"</span>);</span><br><span class="line">&#125;;</span><br><span class="line">ws.onerror = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(“error”);</span><br><span class="line">&#125;;</span><br><span class="line">ws.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(e); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当 new 一个 websocket 对象之后，就会向服务器发送一个 get 请求</p>
<p><a href="https://www.flickr.com/photos/101451303@N08/15857152075" target="_blank" rel="noopener"><img src="https://farm8.staticflickr.com/7525/15857152075_599260fc1e_o.png" alt="request"></a></p>
<p>这个请求是对摸个服务器的端口发送的，一般的话，会预先在服务器将一个socket 绑定到一个端口上，客户端和服务器端在这个预定的端口上通信（我这里绑定的就是 4000 端口，默认情况下，websocke 使用 80 端口）。</p>
<p>然后，在服务器端的socket监听到这个packet 之后就生成一个新的 socket，将发送过来的数据中的 Sec-WebSocket-Key 解析出来，然后按照把“Sec-WebSocket-Ke”加上一个魔幻字符串“258EAFA5-E914-47DA-95CA-C5AB0DC85B11”。使用SHA-1加密，之后进行BASE-64编码，将结果做为“Sec-WebSocket-Accept”头的值，返回给客户端。</p>
<p>客户端收到这个之后，就会将 通信协议 upgrade 到 websocket 协议。</p>
<p><a href="https://www.flickr.com/photos/101451303@N08/15234859044" target="_blank" rel="noopener"><img src="https://farm8.staticflickr.com/7531/15234859044_8e14d892d8_o.png" alt="response"></a></p>
<p>然后就会在这个持久的通道下进行通信，包括浏览器的询问，服务器的push，双方是在一个全双工的状态下相互通信。 切换后的websocket 协议中的 数据传输帧的格式(此时不再使用html协议) 官方文档给出的说明：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>                   <span class="number">1</span>                   <span class="number">2</span>                   <span class="number">3</span></span><br><span class="line">  <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line"> +-+-+-+-+-------+-+-------------+-------------------------------+</span><br><span class="line"> |F|R|R|R| opcode|M| Payload len |    Extended payload length    |</span><br><span class="line"> |I|S|S|S|  (<span class="number">4</span>)  |A|     (<span class="number">7</span>)     |             (<span class="number">16</span>/<span class="number">64</span>)           |</span><br><span class="line"> |N|V|V|V|       |S|             |   (<span class="keyword">if</span> payload len==<span class="number">126</span>/<span class="number">127</span>)   |</span><br><span class="line"> | |<span class="number">1</span>|<span class="number">2</span>|<span class="number">3</span>|       |K|             |                               |</span><br><span class="line"> +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span><br><span class="line"> |     Extended payload length continued, <span class="keyword">if</span> payload len == <span class="number">127</span>  |</span><br><span class="line"> + - - - - - - - - - - - - - - - +-------------------------------+</span><br><span class="line"> |                               |Masking-key, <span class="keyword">if</span> MASK set to <span class="number">1</span>  |</span><br><span class="line"> +-------------------------------+-------------------------------+</span><br><span class="line"> | Masking-key (continued)       |          Payload Data         |</span><br><span class="line"> +-------------------------------- - - - - - - - - - - - - - - - +</span><br><span class="line"> :                     Payload Data continued ...                :</span><br><span class="line"> + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span><br><span class="line"> |                     Payload Data continued ...                |</span><br><span class="line"> +---------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>直接看这个，谁都会有点头大: 我花了一幅图来简单的解释这个 frame 的结构。</p>
<p><a href="https://www.flickr.com/photos/101451303@N08/15857151995" target="_blank" rel="noopener"><img src="https://farm9.staticflickr.com/8623/15857151995_36a28d62a9_o.png" alt="frame"></a></p>
<p>各字段的解释：</p>
<blockquote>
<p>FIN              1bit 表示信息的最后一帧，flag，也就是标记符</p>
<p>RSV 1-3        1bit each 以后备用的 默认都为 0</p>
<p>Opcode         4bit 帧类型，</p>
<p>Mask              1bit 掩码，是否加密数据，默认必须置为1 </p>
<p>Payload len   7bit 数据的长度，当这个7 bit的数据 == 126 时，后面的2 个字节也是表示数     据长度，当它 == 127 时，后面的 8 个字节表示数据长度Masking-key      1 or 4 bit 掩码Payload data  playload len  bytes 数据</p>
</blockquote>
<p>所以我们这里的代码，通过判断 Playload len的值，来用 substr 截取 Masking-key 和 PlayloadData。</p>
<p>根据掩码解析数据的方法是:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">for</span>( i = <span class="number">0</span>; i &lt; data.length ; i++)&#123;</span><br><span class="line"></span><br><span class="line">   orginalData += data[i]  ^  maskingKey[i mod <span class="number">4</span>]; </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在PHP中，当我们收到数据之后，按照这里的格式截取数据，并将其按照这里的方法解析后就得到了浏览器发送过来的数据。 当我们想把数据发送给浏览器时，也要按照这个格式组装frame。 这里是我的方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">frame</span>(<span class="params">$s</span>)</span>&#123;</span><br><span class="line"> 	$a = str_split($s, <span class="number">125</span>);</span><br><span class="line"> 	<span class="keyword">if</span> (count($a) == <span class="number">1</span>)&#123;</span><br><span class="line"> 		<span class="keyword">return</span> <span class="string">"\x81"</span> . chr(strlen($a[<span class="number">0</span>])) . $a[<span class="number">0</span>];</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	$ns = <span class="string">""</span>;</span><br><span class="line"> 	foreach ($a <span class="keyword">as</span> $o)&#123;</span><br><span class="line"> 		$ns .= <span class="string">"\x81"</span> . chr(strlen($o)) . $o;</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	<span class="keyword">return</span> $ns;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>强行将要发送的数据分割成 125 Byte / frame，这样 playload len 只需要 7 bits。也就是直接将数据的长度的ascall码拼接上去，然后后面跟上要发送的数据。 每一个 frame 前面加的 ‘\x81’ 用二进制就是： 1000 0001 1000 ：</p>
<blockquote>
<p>1 是 FIN</p>
<p>000 是三个备用的bit</p>
<p>0001 ： 指的是 opcode 官方的解释：</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">  |Opcode  | Meaning                             | Reference |</span><br><span class="line">-+--------+-------------------------------------+-----------|</span><br><span class="line"> | <span class="number">0</span>      | Continuation Frame                  | RFC <span class="number">6455</span>  |</span><br><span class="line">-+--------+-------------------------------------+-----------|</span><br><span class="line"> | <span class="number">1</span>      | Text Frame                          | RFC <span class="number">6455</span>  |</span><br><span class="line">-+--------+-------------------------------------+-----------|</span><br><span class="line"> | <span class="number">2</span>      | Binary Frame                        | RFC <span class="number">6455</span>  |</span><br><span class="line">-+--------+-------------------------------------+-----------|</span><br><span class="line"> | <span class="number">8</span>      | Connection Close Frame              | RFC <span class="number">6455</span>  |</span><br><span class="line">-+--------+-------------------------------------+-----------|</span><br><span class="line"> | <span class="number">9</span>      | Ping Frame                          | RFC <span class="number">6455</span>  |</span><br><span class="line">-+--------+-------------------------------------+-----------|</span><br><span class="line"> | <span class="number">10</span>     | Pong Frame                          | RFC <span class="number">6455</span>  |</span><br><span class="line">-+--------+-------------------------------------+-----------|</span><br></pre></td></tr></table></figure>
<p>可以设置上图中 opcode 的值，来告诉浏览器这个frame的数据属性。</p>
<h1 id="php-实现简单的-websocket-服务端"><a href="#php-实现简单的-websocket-服务端" class="headerlink" title="php 实现简单的 websocket 服务端"></a>php 实现简单的 websocket 服务端</h1><p>自十月底，html5 宣布定稿之后，新一轮的关于html的讨论便开始了，现在这里，我也为大家介绍一种html5标准中提到的新技术 websocket，以及他的 php 实现范例。</p>
<blockquote>
<p><strong>WebSocket</strong>是<a href="http://zh.wikipedia.org/wiki/HTML5" target="_blank" rel="noopener">HTML5</a>开始提供的一种<a href="http://zh.wikipedia.org/wiki/%E6%B5%8F%E8%A7%88%E5%99%A8" target="_blank" rel="noopener">浏览器</a>与<a href="http://zh.wikipedia.org/wiki/%E6%9C%8D%E5%8A%A1%E5%99%A8" target="_blank" rel="noopener">服务器</a>间进行<a href="http://zh.wikipedia.org/wiki/%E5%85%A8%E9%9B%99%E5%B7%A5" target="_blank" rel="noopener">全双工</a>通讯的网络技术。WebSocket通信协议于2011年被<a href="http://zh.wikipedia.org/wiki/Internet_Engineering_Task_Force" target="_blank" rel="noopener">IETF</a>定为标准<a href="http://tools.ietf.org/html/rfc6455" target="_blank" rel="noopener">RFC 6455</a>，WebSocket<a href="http://zh.wikipedia.org/wiki/Application_programming_interface" target="_blank" rel="noopener">API</a>被<a href="http://zh.wikipedia.org/wiki/World_Wide_Web_Consortium" target="_blank" rel="noopener">W3C</a>定为标准。</p>
<p>在WebSocket API中，浏览器和服务器只需要做一个握手的动作，然后，浏览器和服务器之间就形成了一条快速通道。两者之间就直接可以数据互相传送。</p>
</blockquote>
<p>传统的web程序，都遵循这样的执行方式，浏览器发送一个请求，然后服务器端接收这个请求，处理完成浏览器的请求之后，再将处理完成的结果返回给浏览器，然后浏览器处理返回的html，将其呈现给用户。如下图所示：</p>
<p><a href="https://www.flickr.com/photos/101451303@N08/15831324266" target="_blank" rel="noopener"><img src="https://farm9.staticflickr.com/8598/15831324266_5e16ea3fc1_o.png" alt="server"></a></p>
<p>即使后来出现了ajax这样的新的技术，它实际也是使用javascript的api来向服务器发送请求，然后等待相应的数据。也就是说，在浏览器和服务器的交互中，我们每想得到一个得到新的数据（更新页面，获得服务器端的最新状态）就必须要发起一个http请求，建立一条TCP/IP链接，当这次请求的数据被浏览器接收到之后，就断开这条TCP/IP连接。</p>
<p>新的websocket技术，在浏览器端发起一条请求之后，服务器端与浏览器端的请求进行握手应答之后，就建立起一条长久的，双工的长连接，基于这条连接，我们不必做一些轮询就能随时获得服务器端的状态，服务器也不必等待浏览器端的请求才能向用户推送数据，可以在这条连接上随时向以建立websocket连接的用户 push 数据。</p>
<p><a href="http://datatracker.ietf.org/doc/rfc6455/?include_text=1" target="_blank" rel="noopener">这里</a>是 websocket 协议的 RFC 文档。</p>
<p>我这里的实现是基于 php sockets的实现，调用了来自 php.net 的 socket-api  <a href="http://php.net/manual/zh/book.sockets.php" target="_blank" rel="noopener">php socket</a> .</p>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">WsServer</span></span>&#123;</span><br><span class="line">      <span class="keyword">public</span>  $socket;</span><br><span class="line">      <span class="keyword">public</span>  $socketArray;</span><br><span class="line">      <span class="keyword">public</span>  $activatedSocketArray;</span><br><span class="line">      <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($address,$port)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;socket =  <span class="keyword">$this</span>-&gt;init($address,$port);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;socket == <span class="keyword">null</span>)</span><br><span class="line">          <span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">        </span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">($address,$port)</span></span>&#123;</span><br><span class="line">       $wssocket  = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);</span><br><span class="line">     socket_set_option($wssocket, SOL_SOCKET, SO_REUSEADDR, <span class="number">1</span>);</span><br><span class="line">     socket_bind($wssocket,$address,$port);</span><br><span class="line">     <span class="keyword">if</span>(socket_listen($wssocket))&#123;</span><br><span class="line">          <span class="keyword">$this</span>-&gt;p(<span class="string">"Socket init success"</span>);</span><br><span class="line">          <span class="keyword">return</span> $wssocket;</span><br><span class="line">     &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;p(<span class="string">"Socket init failure"</span>);</span><br><span class="line">      <span class="keyword">exit</span>();</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;socketArray[] = <span class="keyword">$this</span>-&gt;socket;</span><br><span class="line">      $write  = <span class="keyword">NULL</span>;</span><br><span class="line">      $except = <span class="keyword">NULL</span>;</span><br><span class="line">      <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;activatedSocketArray = <span class="keyword">$this</span>-&gt;socketArray;</span><br><span class="line">      socket_select(<span class="keyword">$this</span>-&gt;activatedSocketArray, $write, $except, <span class="keyword">null</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">foreach</span>(<span class="keyword">$this</span>-&gt;activatedSocketArray <span class="keyword">as</span> $s)&#123;</span><br><span class="line">       <span class="keyword">if</span>($s == <span class="keyword">$this</span>-&gt;socket)&#123;</span><br><span class="line">         $client = socket_accept(<span class="keyword">$this</span>-&gt;socket);</span><br><span class="line">         socket_recv($client, $buffer, <span class="number">2048</span>, <span class="number">0</span>);</span><br><span class="line">       </span><br><span class="line">         <span class="comment">// response a handshake response</span></span><br><span class="line">         <span class="keyword">if</span>(socket_write($client, <span class="keyword">$this</span>-&gt;handshakeResponse($buffer))!== <span class="keyword">false</span>)&#123;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;p(<span class="string">'add a socket into the queue'</span>);</span><br><span class="line">           array_push(<span class="keyword">$this</span>-&gt;socketArray, $client);</span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">             <span class="keyword">$this</span>-&gt;p(<span class="string">'error on handshake'</span>);</span><br><span class="line">             <span class="keyword">$this</span>-&gt;errorLog(socket_last_error());</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        socket_recv($s, $buffer, <span class="number">2048</span>, <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        $frame = <span class="keyword">$this</span>-&gt;parseFrame($buffer);</span><br><span class="line">        var_dump($frame);</span><br><span class="line">          $str  = <span class="keyword">$this</span>-&gt;decode($buffer);</span><br><span class="line">          $str = <span class="keyword">$this</span>-&gt;frame($str);</span><br><span class="line">        socket_write($s,$str,strlen($str));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  parse the frame</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">parseFrame</span><span class="params">($d)</span></span>&#123;</span><br><span class="line">      $firstByte = ord(substr($d,<span class="number">0</span>,<span class="number">1</span>));</span><br><span class="line">      $result =<span class="keyword">array</span>();</span><br><span class="line">      $result[<span class="string">'FIN'</span>] = <span class="keyword">$this</span>-&gt;getBit($firstByte,<span class="number">1</span>);</span><br><span class="line">      $result[<span class="string">'opcode'</span>] = $firstByte &amp; <span class="number">15</span>;</span><br><span class="line">      $result[<span class="string">'length'</span>] = ord(substr($d,<span class="number">1</span>,<span class="number">1</span>)) &amp; <span class="number">127</span>;</span><br><span class="line">      <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getBit</span><span class="params">($m,$n)</span></span>&#123;</span><br><span class="line">       <span class="keyword">return</span>  ($n &gt;&gt; ($m<span class="number">-1</span>)) &amp; <span class="number">1</span>;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     *   build the data frame sent to client by server socket.  </span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * **/</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">frame</span><span class="params">($s)</span></span>&#123;</span><br><span class="line">      $a = str_split($s, <span class="number">125</span>);</span><br><span class="line">      <span class="keyword">if</span> (count($a) == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"\x81"</span> . chr(strlen($a[<span class="number">0</span>])) . $a[<span class="number">0</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      $ns = <span class="string">""</span>;</span><br><span class="line">      <span class="keyword">foreach</span> ($a <span class="keyword">as</span> $o)&#123;</span><br><span class="line">        $ns .= <span class="string">"\x81"</span> . chr(strlen($o)) . $o;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> $ns;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * decode the client socket input </span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * **/</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">decode</span><span class="params">($buffer)</span> </span>&#123;</span><br><span class="line">      $len = $masks = $data = $decoded = <span class="keyword">null</span>;</span><br><span class="line">      $len = ord($buffer[<span class="number">1</span>]) &amp; <span class="number">127</span>;</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> ($len === <span class="number">126</span>) &#123;</span><br><span class="line">        $masks = substr($buffer, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">        $data = substr($buffer, <span class="number">8</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ($len === <span class="number">127</span>) &#123;</span><br><span class="line">        $masks = substr($buffer, <span class="number">10</span>, <span class="number">4</span>);</span><br><span class="line">        $data = substr($buffer, <span class="number">14</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        $masks = substr($buffer, <span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line">        $data = substr($buffer, <span class="number">6</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">for</span> ($index = <span class="number">0</span>; $index &lt; strlen($data); $index++) &#123;</span><br><span class="line">        $decoded .= $data[$index] ^ $masks[$index % <span class="number">4</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> $decoded;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * params <span class="doctag">@requestHeaders</span> : read from request socket</span></span><br><span class="line"><span class="comment">   * return an array of request </span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">parseHeaders</span><span class="params">($requsetHeaders)</span></span>&#123;</span><br><span class="line">      $resule =<span class="keyword">array</span>();</span><br><span class="line">      <span class="keyword">if</span> (preg_match(<span class="string">"/GET (.*) HTTP/"</span>              ,$requsetHeaders,$match)) &#123; $resule[<span class="string">'reuqest'</span>] = $match[<span class="number">1</span>]; &#125;</span><br><span class="line">      <span class="keyword">if</span> (preg_match(<span class="string">"/Host: (.*)\r\n/"</span>             ,$requsetHeaders,$match)) &#123; $result[<span class="string">'host'</span>] = $match[<span class="number">1</span>]; &#125;</span><br><span class="line">      <span class="keyword">if</span> (preg_match(<span class="string">"/Origin: (.*)\r\n/"</span>           ,$requsetHeaders,$match)) &#123; $result[<span class="string">'origin'</span>] = $match[<span class="number">1</span>]; &#125;</span><br><span class="line">      <span class="keyword">if</span> (preg_match(<span class="string">"/Sec-WebSocket-Key: (.*)\r\n/"</span>,$requsetHeaders,$match)) &#123; $result[<span class="string">'key'</span>] = $match[<span class="number">1</span>]; &#125;</span><br><span class="line">      <span class="keyword">return</span> $result;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * protocol version : 13</span></span><br><span class="line"><span class="comment">     * generting the key of handshaking</span></span><br><span class="line"><span class="comment">     * return encrypted key</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getKey</span><span class="params">($requestKey)</span></span>&#123;</span><br><span class="line">      <span class="keyword">return</span> base64_encode(sha1($requestKey . <span class="string">'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'</span>, <span class="keyword">true</span>));</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**params <span class="doctag">@parseRequest</span> : request written in socket</span></span><br><span class="line"><span class="comment">     * return handshakResponse witten in response socket</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span>  <span class="title">handshakeResponse</span><span class="params">($request)</span></span>&#123;</span><br><span class="line">      $parsedRequest  = <span class="keyword">$this</span>-&gt;parseHeaders($request);</span><br><span class="line">      $encryptedKey = <span class="keyword">$this</span>-&gt;getKey($parsedRequest[<span class="string">'key'</span>]);</span><br><span class="line">      $response  = <span class="string">"HTTP/1.1 101 Switching Protocol\r\n"</span> .</span><br><span class="line">          <span class="string">"Upgrade: websocket\r\n"</span> .</span><br><span class="line">          <span class="string">"Connection: Upgrade\r\n"</span> .</span><br><span class="line">          <span class="string">"Sec-WebSocket-Accept: "</span> .$encryptedKey. <span class="string">"\r\n\r\n"</span>;</span><br><span class="line">      <span class="keyword">return</span> $response;</span><br><span class="line">              </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * report last_error in socket </span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">errorLog</span><span class="params">($ms)</span></span>&#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">'Error:\n'</span>.$ms;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * print the log</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">private</span>  <span class="function"><span class="keyword">function</span> <span class="title">p</span><span class="params">($e)</span></span>&#123;</span><br><span class="line">      <span class="keyword">echo</span> $e.<span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">      $read[] = <span class="keyword">$this</span>-&gt;socket;</span><br><span class="line">      $write = <span class="keyword">null</span>;</span><br><span class="line">      $except = <span class="keyword">null</span>;</span><br><span class="line">      socket_select($read, $write, $except,<span class="keyword">null</span>);</span><br><span class="line">      var_dump($read);</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  $w = <span class="keyword">new</span> WsServer(<span class="string">'localhost'</span>,<span class="number">4000</span>);</span><br><span class="line">  $w-&gt;run();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这个类主要实现了对websocket的握手回应，将每一个连接成功的websocket加入到一个数组中之后，就能够在服务器端对多个websocket 客户端进行处理。</p>
<p>对websocket的握手请求，在接收到的报文中 会得到一个 Sec-WebSocket-Key 字段，要把“Sec-WebSocket-Key”加上一个魔幻字符串“258EAFA5-E914-47DA-95CA-C5AB0DC85B11”。使用SHA-1加密，之后进行BASE-64编码，将结果做为“Sec-WebSocket-Accept”头的值，返回给客户端。这样就完成了与客户端之间的握手。</p>
<p>之后，就能在服务器端监听客户端发来的请求了，同时也可以操作在服务端的socket句柄，来向浏览器推送消息。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">liukai93</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">liukai93</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
